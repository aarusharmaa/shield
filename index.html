<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shield: Your Safety Shield</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #f0f2f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --primary-color: #ef4444;
            --secondary-color: #3b82f6;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --button-hover-bg: #dc2626;
            --button-text-color: #ffffff;
            --input-border: #d1d5db;
            --placeholder-color: #9ca3af;
            --error-color: #ef4444;
            --success-color: #22c55e;
            --info-color: #3b82f6;
            --loading-color: #6366f1;
        }
        .dark-mode {
            --background-color: #1a202c;
            --card-background: #2d3748;
            --text-color: #e2e8f0;
            --primary-color: #f87171;
            --secondary-color: #60a5fa;
            --border-color: #4a5568;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --button-hover-bg: #ef4444;
            --button-text-color: #ffffff;
            --input-border: #4a5568;
            --placeholder-color: #a0aec0;
            --error-color: #f87171;
            --success-color: #4ade80;
            --info-color: #60a5fa;
            --loading-color: #818cf8;
        }
        .high-contrast-mode {
            --background-color: #000000;
            --card-background: #111111;
            --text-color: #ffff00;
            --primary-color: #ff00ff;
            --secondary-color: #00ffff;
            --border-color: #555555;
            --shadow-color: rgba(255, 255, 0, 0.2);
            --button-hover-bg: #cc00cc;
            --button-text-color: #ffffff;
            --input-border: #aaaaaa;
            --placeholder-color: #cccccc;
            --error-color: #ff3333;
            --success-color: #33ff33;
            --info-color: #00ccff;
            --loading-color: #ffaa00;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }
        header {
            background-color: var(--card-background);
            padding: 15px 20px;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            border-radius: 0 0 10px 10px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .logo {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }
        .logo svg {
            margin-right: 8px;
            width: 28px;
            height: 28px;
            fill: var(--primary-color);
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        .header-controls button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
        .header-controls button:hover {
            background-color: var(--border-color);
        }
        .header-controls select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--input-border);
            background-color: var(--card-background);
            color: var(--text-color);
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .header-controls select:focus {
            outline: none;
            border-color: var(--secondary-color);
        }
        .mode-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1.2em;
        }
        .mode-toggle input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .mode-toggle .slider {
            width: 40px;
            height: 20px;
            background-color: #ccc;
            border-radius: 20px;
            position: relative;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        .mode-toggle .slider:before {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        .mode-toggle input:checked + .slider {
            background-color: var(--secondary-color);
        }
        .mode-toggle input:checked + .slider:before {
            transform: translateX(20px);
        }
        main {
            flex-grow: 1;
            padding: 20px 0;
        }
        .section {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 8px var(--shadow-color);
            padding: 30px;
            margin-bottom: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            animation: fadeIn 0.8s ease-out;
        }
        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px var(--shadow-color);
        }
        .section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section h2 svg {
            fill: var(--primary-color);
            width: 24px;
            height: 24px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            color: var(--button-text-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background-color: var(--secondary-color);
        }
        .btn-secondary:hover {
            background-color: #3070d6;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--secondary-color);
            color: var(--secondary-color);
            box-shadow: none;
        }
        .btn-outline:hover {
            background-color: var(--secondary-color);
            color: var(--button-text-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="text"],
        .form-group input[type="tel"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.2s, background-color 0.2s;
        }
        .form-group input::placeholder {
            color: var(--placeholder-color);
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .error-message {
            color: var(--error-color);
            font-size: 0.9em;
            margin-top: 5px;
        }
        #alerts-list {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        .alert-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .alert-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }
        .alert-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 10px 0 0 10px;
        }
        .alert-card h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .alert-card p {
            margin-bottom: 8px;
            font-size: 0.95em;
            line-height: 1.5;
        }
        .alert-card .alert-time {
            font-size: 0.8em;
            color: var(--placeholder-color);
            text-align: right;
            margin-top: 10px;
        }
        #map {
            width: 100%;
            height: 400px;
            background-color: var(--border-color);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            color: var(--text-color);
            text-align: center;
        }
        #contacts-list {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            margin-top: 20px;
        }
        .contact-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        .contact-card p {
            margin: 0;
            font-size: 1.05em;
        }
        .contact-card button {
            background-color: var(--error-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .contact-card button:hover {
            background-color: #c0392b;
        }
        #sos-section {
            text-align: center;
        }
        #sos-button {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            font-size: 2.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px auto;
            border: 8px solid var(--button-hover-bg);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6);
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            animation: pulse 2s infinite;
        }
        #sos-button:hover {
            background-color: var(--button-hover-bg);
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
            animation: none;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .message-box {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-background);
            color: var(--text-color);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .message-box.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-10px);
        }
        .message-box.success {
            background-color: var(--success-color);
            color: var(--button-text-color);
        }
        .message-box.error {
            background-color: var(--error-color);
            color: var(--button-text-color);
        }
        .message-box.info {
            background-color: var(--info-color);
            color: var(--button-text-color);
        }
        .message-box .icon {
            font-size: 1.5em;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1002;
            color: white;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .spinner {
            border: 8px solid rgba(255, 255, 255, 0.3);
            border-top: 8px solid var(--loading-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-message {
            margin-top: 20px;
            font-size: 1.2em;
            text-align: center;
        }
        #error-page {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 50px 20px;
            flex-grow: 1;
        }
        #error-page.show {
            display: flex;
        }
        #error-page h1 {
            font-size: 4em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        #error-page p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 600px;
        }
        .hidden {
            display: none !important;
        }
        .text-center {
            text-align: center;
        }
        .mt-4 {
            margin-top: 1rem;
        }
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .header-controls {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            .section {
                padding: 20px;
            }
            .section h2 {
                font-size: 1.5em;
            }
            .btn {
                width: 100%;
                padding: 10px 20px;
                font-size: 1em;
            }
            .btn-group {
                flex-direction: column;
            }
            #map {
                height: 300px;
            }
            #sos-button {
                width: 150px;
                height: 150px;
                font-size: 2em;
            }
        }
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            header {
                padding: 10px;
            }
            .logo {
                font-size: 1.5em;
            }
            .header-controls {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            .header-controls button,
            .header-controls select {
                width: 100%;
            }
            .section {
                padding: 15px;
            }
            .alert-card, .contact-card {
                padding: 15px;
            }
            #sos-button {
                width: 120px;
                height: 120px;
                font-size: 1.8em;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in-up {
            animation: fadeIn 0.6s ease-out forwards;
        }
        #tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 99999; /* HIGHEST Z-INDEX for the overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #tutorial-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .tutorial-card {
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            animation: slideIn 0.5s ease-out;
            z-index: 100000; /* HIGHER THAN OVERLAY for the card itself */
        }
        @keyframes slideIn {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .tutorial-card .character {
            font-size: 3em;
            margin-bottom: 10px;
        }
        .tutorial-card .tutorial-message {
            font-size: 1.2em;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .tutorial-card .tutorial-controls {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
        .tutorial-highlight {
            position: relative;
            z-index: 100001; /* HIGHEST Z-INDEX for the highlighted element */
            box-shadow: 0 0 0 5px var(--secondary-color), 0 0 15px var(--secondary-color);
            transition: box-shadow 0.3s ease;
            border-radius: 12px;
        }
        .tutorial-highlight::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background-color: transparent;
            z-index: -1;
            border-radius: 15px;
        }
        @media (max-width: 600px) {
            .tutorial-card {
                padding: 20px;
            }
            .tutorial-card .tutorial-message {
                font-size: 1em;
            }
            .tutorial-card .tutorial-controls {
                flex-direction: column;
            }
            .tutorial-card .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
        .message-feed {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--background-color);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column; /* New messages appear at the bottom */
        }
        .message-item {
            padding: 10px;
            border-bottom: 1px dashed var(--border-color);
            word-wrap: break-word;
            font-size: 0.95em;
            animation: fadeInMessage 0.5s ease-out forwards;
        }
        .message-item:last-child {
            border-bottom: none;
        }
        .message-item strong {
            color: var(--secondary-color);
        }
        .message-input-group {
            display: flex;
            gap: 10px;
        }
        .message-input-group input {
            flex-grow: 1;
        }
        .read-aloud-btn {
            background-color: var(--secondary-color);
            color: var(--button-text-color);
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .read-aloud-btn:hover {
            background-color: #3070d6;
        }
        @keyframes fadeInMessage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* This blocker is no longer needed with proper z-index on tutorial-overlay */
        /* #map-click-blocker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            z-index: 9998;
            display: none;
        } */
    </style>
</head>
<body>
    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p id="loading-message">Loading Shield...</p>
    </div>
    <div id="message-box" class="message-box">
        <span class="icon"></span>
        <span class="message-text"></span>
    </div>
    <div id="tutorial-overlay" class="hidden">
        <div class="tutorial-card">
            <div class="character" id="tutorial-character"></div>
            <p class="tutorial-message" id="tutorial-message"></p>
            <div class="tutorial-controls">
                <button class="btn btn-outline" id="tutorial-skip-btn" data-lang-key="tutorialSkip">Skip Tour</button>
                <button class="btn btn-secondary" id="tutorial-prev-btn" data-lang-key="tutorialPrev">Previous</button>
                <button class="btn btn-primary" id="tutorial-next-btn" data-lang-key="tutorialNext">Next</button>
            </div>
        </div>
    </div>
    <!-- The map-click-blocker is removed as the z-index on tutorial-overlay now handles blocking clicks -->
    <header>
        <div class="logo">
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7V17L12 22L22 17V7L12 2ZM12 4.472L19.866 8.736L12 13L4.134 8.736L12 4.472ZM4 10.278L11 14.167V19.528L4 15.639V10.278ZM13 14.167L20 10.278V15.639L13 19.528V14.167Z"/>
            </svg>
            Shield
        </div>
        <div class="header-controls">
            <button id="start-tour-btn" class="btn btn-outline" data-lang-key="startTour">Start Tour</button>
            <label class="mode-toggle">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
                <span id="darkModeLabel">Light Mode</span>
            </label>
            <label class="mode-toggle">
                <input type="checkbox" id="highContrastToggle">
                <span class="slider"></span>
                <span id="highContrastLabel">High Contrast</span>
            </label>
            <button id="voice-commands-btn" class="btn btn-outline" data-lang-key="voiceCommands">Voice Commands</button>
            <select id="language-switcher">
                <option value="en">English</option>
                <option value="hi">हिंदी</option>
                <option value="es">Español</option>
            </select>
        </div>
    </header>
    <main id="app-content" class="container">
        <section id="alert-section" class="section fade-in-up">
            <h2>
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L1 21H23L12 2ZM13 8V14H11V8H13ZM13 16V18H11V16H13Z"/>
                </svg>
                <span data-lang-key="alertsTitle">Real-Time Disaster Alerts</span>
                <button class="read-aloud-btn" data-section="alert-section">Read Section</button>
            </h2>
            <p data-lang-key="alertsDescription">Get instant updates on hazards near your location.</p>
            <div id="alerts-list">
            </div>
            <button id="refresh-alerts-btn" class="btn btn-secondary mt-4" data-lang-key="refreshAlerts">Refresh Alerts</button>
        </section>
        <section id="map-section" class="section fade-in-up">
            <h2>
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z"/>
                </svg>
                <span data-lang-key="mapTitle">Smart Navigation & Safe Routes</span>
                <button class="read-aloud-btn" data-section="map-section">Read Section</button>
            </h2>
            <p data-lang-key="mapDescription">Visualize danger zones and find the safest evacuation routes.</p>
            <div id="map">
                <p id="map-error-message" style="color: var(--error-color); display: none;"></p>
            </div>
        </section>
        <section id="sos-section" class="section fade-in-up">
            <h2>
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 15H13V17H11V15ZM11 7H13V13H11V7Z"/>
                </svg>
                <span data-lang-key="sosTitle">One-Click Emergency SOS</span>
                <button class="read-aloud-btn" data-section="sos-section">Read Section</button>
            </h2>
            <p data-lang-key="sosDescription">Instantly notify your trusted contacts during a crisis.</p>
            <button id="sos-button" class="btn-primary" data-lang-key="sosButton">SOS</button>
        </section>
        <section id="contacts-section" class="section fade-in-up">
            <h2>
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z"/>
                </svg>
                <span data-lang-key="contactsTitle">Trusted Emergency Contacts</span>
                <button class="read-aloud-btn" data-section="contacts-section">Read Section</button>
            </h2>
            <p data-lang-key="contactsDescription">Add phone numbers to alert quickly in an emergency.</p>
            <form id="add-contact-form">
                <div class="form-group">
                    <label for="contact-name" data-lang-key="contactNameLabel">Contact Name</label>
                    <input type="text" id="contact-name" placeholder="John Doe" required>
                    <div id="contact-name-error" class="error-message hidden"></div>
                </div>
                <div class="form-group">
                    <label for="contact-phone" data-lang-key="contactPhoneLabel">Phone Number</label>
                    <input type="tel" id="contact-phone" placeholder="+1234567890" required pattern="^\+\d{1,15}$">
                    <div id="contact-phone-error" class="error-message hidden"></div>
                </div>
                <button type="submit" class="btn btn-secondary" data-lang-key="addContactButton">Add Contact</button>
            </form>
            <div id="contacts-list">
            </div>
        </section>
        <section id="shared-status-section" class="section fade-in-up">
            <h2>
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                    <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM18 14H6V12H18V14ZM18 11H6V9H18V11Z"/>
                </svg>
                <span data-lang-key="sharedStatusTitle">Shared Status Updates</span>
                <button class="read-aloud-btn" data-section="shared-status-section">Read Section</button>
            </h2>
            <p data-lang-key="sharedStatusDescription">Share real-time updates with other users (simulated multi-user interaction).</p>
            <div id="message-feed" class="message-feed">
            </div>
            <form id="send-message-form" class="message-input-group">
                <input type="text" id="message-input" placeholder="Type your status update..." required>
                <button type="submit" class="btn btn-secondary" data-lang-key="sendMessageButton">Send</button>
            </form>
            <p class="mt-4 text-center" data-lang-key="sharedStatusNote">
                *This is a public, shared feed. True multi-user identification requires user accounts.
            </p>
        </section>
    </main>
    <div id="error-page" class="hidden">
        <h1>404</h1>
        <p data-lang-key="errorPageMessage">Oops! Something went wrong or the page you're looking for doesn't exist.</p>
        <button class="btn btn-secondary" onclick="window.location.reload()" data-lang-key="reloadPageButton">Reload Page</button>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, deleteDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY",
            authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
            messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
            appId: "YOUR_FIREBASE_APP_ID"
        };
        const appId = firebaseConfig.projectId || 'default-shield-app'; 
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        let isMapScriptLoaded = false;
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        const messageBox = document.getElementById('message-box');
        const messageText = messageBox.querySelector('.message-text');
        const messageIcon = messageBox.querySelector('.icon');
        const appContent = document.getElementById('app-content');
        const errorPage = document.getElementById('error-page');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const darkModeLabel = document.getElementById('darkModeLabel');
        const highContrastToggle = document.getElementById('highContrastToggle');
        const highContrastLabel = document.getElementById('highContrastLabel');
        const voiceCommandsBtn = document.getElementById('voice-commands-btn');
        const languageSwitcher = document.getElementById('language-switcher');
        const mapErrorMessage = document.getElementById('map-error-message');
        const alertsList = document.getElementById('alerts-list');
        const refreshAlertsBtn = document.getElementById('refresh-alerts-btn');
        const sosButton = document.getElementById('sos-button');
        const addContactForm = document.getElementById('add-contact-form');
        const contactNameInput = document.getElementById('contact-name');
        const contactPhoneInput = document.getElementById('contact-phone');
        const contactNameError = document.getElementById('contact-name-error');
        const contactPhoneError = document.getElementById('contact-phone-error');
        const contactsList = document.getElementById('contacts-list');
        const startTourBtn = document.getElementById('start-tour-btn');
        const tutorialOverlay = document.getElementById('tutorial-overlay');
        const tutorialCharacter = document.getElementById('tutorial-character');
        const tutorialMessage = document.getElementById('tutorial-message');
        const tutorialPrevBtn = document.getElementById('tutorial-prev-btn');
        const tutorialNextBtn = document.getElementById('tutorial-next-btn');
        const tutorialSkipBtn = document.getElementById('tutorial-skip-btn');
        const messageFeed = document.getElementById('message-feed');
        const sendMessageForm = document.getElementById('send-message-form');
        const messageInput = document.getElementById('message-input');
        const translations = {
            en: {
                darkModeLabel: "Light Mode",
                highContrastLabel: "High Contrast",
                voiceCommands: "Voice Commands",
                alertsTitle: "Real-Time Disaster Alerts",
                alertsDescription: "Get instant updates on hazards near your location.",
                refreshAlerts: "Refresh Alerts",
                mapTitle: "Smart Navigation & Safe Routes",
                mapDescription: "Visualize danger zones and find the safest evacuation routes.",
                sosTitle: "One-Click Emergency SOS",
                sosDescription: "Instantly notify your trusted contacts during a crisis.",
                sosButton: "SOS",
                contactsTitle: "Trusted Emergency Contacts",
                contactsDescription: "Add phone numbers to alert quickly in an emergency.",
                contactNameLabel: "Contact Name",
                contactPhoneLabel: "Phone Number",
                addContactButton: "Add Contact",
                loadingApp: "Loading Shield...",
                loadingAlerts: "Fetching real-time alerts...",
                loadingMap: "Loading map and routes...",
                loadingContacts: "Retrieving trusted contacts...",
                alertSuccess: "SOS sent successfully (simulated)! Stay safe.",
                alertError: "Failed to send SOS. Please try again.",
                contactAdded: "Contact added successfully!",
                contactRemoved: "Contact removed.",
                contactAddError: "Failed to add contact.",
                contactRemoveError: "Failed to remove contact.",
                emailRequired: "Email is required.", 
                emailInvalid: "Please enter a valid email address.",
                passwordRequired: "Password is required.",
                passwordMinLength: "Password must be at least 6 characters.",
                contactNameRequired: "Contact name is required.",
                contactPhoneRequired: "Phone number is required.",
                contactPhoneInvalid: "Please enter a valid phone number (e.g., +1234567890).",
                errorPageMessage: "Oops! Something went wrong or the page you're looking for doesn't exist.",
                reloadPageButton: "Reload Page",
                darkModeOn: "Dark Mode",
                lightModeOn: "Light Mode",
                userIdDisplay: "User ID:", 
                mapApiError: "Google Maps API not activated or invalid key. Please enable the Maps JavaScript API in your Google Cloud project for this API key: https://console.cloud.google.com/apis/library/maps-platform-apis",
                startTour: "Start Tour",
                tutorialSkip: "Skip Tour",
                tutorialPrev: "Previous",
                tutorialNext: "Next",
                tutorialWelcome: "Hello! I'm your guide to Shield. Let's explore its features.",
                tutorialAlerts: "This section provides real-time disaster alerts. Stay informed about hazards near you.",
                tutorialMap: "Here you can see your location and potential danger zones on the map. It helps you find safe routes.",
                tutorialSOS: "In an emergency, just one click on this SOS button will notify your trusted contacts.",
                tutorialContacts: "Manage your emergency contacts here. Add or remove people you want to alert during a crisis.",
                tutorialEnd: "You are finished!",
                sharedStatusTitle: "Shared Status Updates",
                sharedStatusDescription: "Share real-time updates with other users (simulated multi-user interaction).",
                sendMessageButton: "Send",
                sharedStatusNote: "*This is a public, shared feed. True multi-user identification requires user accounts.",
                messageSent: "Message sent!",
                messageSendError: "Failed to send message.",
                loadingMessages: "Loading shared messages...",
                readSection: "Read Section",
                voiceCommandsActive: "Voice commands active. Say 'SOS' or 'Refresh Alerts'.",
                voiceCommandsStopped: "Voice commands stopped.",
                commandRecognized: "Command recognized: ",
                commandNotRecognized: "Command not recognized. Please try again."
            },
            hi: {
                darkModeLabel: "लाइट मोड",
                highContrastLabel: "उच्च कंट्रास्ट",
                voiceCommands: "वॉयस कमांड",
                alertsTitle: "वास्तविक समय आपदा अलर्ट",
                alertsDescription: "अपने स्थान के पास खतरों पर तत्काल अपडेट प्राप्त करें।",
                refreshAlerts: "अलर्ट ताज़ा करें",
                mapTitle: "स्मार्ट नेविगेशन और सुरक्षित मार्ग",
                mapDescription: "खतरनाक क्षेत्रों की कल्पना करें और सबसे सुरक्षित निकासी मार्ग खोजें।",
                sosTitle: "एक-क्लिक आपातकालीन एसओएस",
                sosDescription: "संकट के दौरान अपने विश्वसनीय संपर्कों को तुरंत सूचित करें।",
                sosButton: "एसओएस",
                contactsTitle: "विश्वसनीय आपातकालीन संपर्क",
                contactsDescription: "आपातकाल में तुरंत अलर्ट करने के लिए फोन नंबर जोड़ें।",
                contactNameLabel: "संपर्क नाम",
                contactPhoneLabel: "फोन नंबर",
                addContactButton: "संपर्क जोड़ें",
                loadingApp: "शील्ड लोड हो रहा है...",
                loadingAlerts: "वास्तविक समय अलर्ट प्राप्त कर रहा है...",
                loadingMap: "मानचित्र और मार्ग लोड हो रहा है...",
                loadingContacts: "विश्वसनीय संपर्क पुनः प्राप्त कर रहा है...",
                alertSuccess: "एसओएस सफलतापूर्वक भेजा गया (सिम्युलेटेड)! सुरक्षित रहें।",
                alertError: "एसओएस भेजने में विफल। कृपया पुनः प्रयास करें।",
                contactAdded: "संपर्क सफलतापूर्वक जोड़ा गया!",
                contactRemoved: "संपर्क हटा दिया गया।",
                contactAddError: "संपर्क जोड़ने में विफल।",
                contactRemoveError: "संपर्क हटाने में विफल।",
                emailRequired: "ईमेल आवश्यक है।",
                emailInvalid: "कृपया एक वैध ईमेल पता दर्ज करें।",
                passwordRequired: "पासवर्ड आवश्यक है।",
                passwordMinLength: "पासवर्ड कम से कम 6 वर्णों का होना चाहिए।",
                contactNameRequired: "संपर्क नाम आवश्यक है।",
                contactPhoneRequired: "फोन नंबर आवश्यक है।",
                contactPhoneInvalid: "कृपया एक वैध फोन नंबर दर्ज करें (उदाहरण: +1234567890)।",
                errorPageMessage: "उफ़! कुछ गलत हो गया या आप जिस पृष्ठ की तलाश कर रहे हैं वह मौजूद नहीं है।",
                reloadPageButton: "पृष्ठ पुनः लोड करें",
                darkModeOn: "डार्क मोड",
                lightModeOn: "लाइट मोड",
                userIdDisplay: "उपयोगकर्ता आईडी:",
                mapApiError: "Google Maps API सक्रिय नहीं है या कुंजी अमान्य है। कृपया इस एपीआई कुंजी के लिए अपने Google Cloud प्रोजेक्ट में Maps JavaScript API सक्षम करें: https://console.cloud.google.com/apis/library/maps-platform-apis",
                startTour: "टूर शुरू करें",
                tutorialSkip: "टूर छोड़ें",
                tutorialPrev: "पिछला",
                tutorialNext: "अगला",
                tutorialWelcome: "नमस्ते! मैं शील्ड के लिए आपका मार्गदर्शक हूँ। आइए इसकी विशेषताओं का अन्वेषण करें।",
                tutorialAlerts: "यह अनुभाग वास्तविक समय आपदा अलर्ट प्रदान करता है। अपने आस-पास के खतरों के बारे में सूचित रहें।",
                tutorialMap: "यहां आप मानचित्र पर अपना स्थान और संभावित खतरनाक क्षेत्र देख सकते हैं। यह आपको सुरक्षित मार्ग खोजने में मदद करता है।",
                tutorialSOS: "आपातकाल में, इस एसओएस बटन पर सिर्फ एक क्लिक आपके विश्वसनीय संपर्कों को सूचित करेगा।",
                tutorialContacts: "यहां अपने आपातकालीन संपर्कों को प्रबंधित करें। संकट के दौरान उन लोगों को जोड़ें या हटाएँ जिन्हें आप अलर्ट करना चाहते हैं।",
                tutorialEnd: "आप समाप्त कर चुके हैं!",
                sharedStatusTitle: "साझा स्थिति अपडेट",
                sharedStatusDescription: "अन्य उपयोगकर्ताओं के साथ वास्तविक समय अपडेट साझा करें (सिम्युलेटेड मल्टी-यूजर इंटरैक्शन)।",
                sendMessageButton: "भेजें",
                sharedStatusNote: "*यह एक सार्वजनिक, साझा फ़ीड है। वास्तविक मल्टी-यूजर पहचान के लिए उपयोगकर्ता खातों की आवश्यकता होती है।",
                messageSent: "संदेश भेजा गया!",
                messageSendError: "संदेश भेजने में विफल।",
                readSection: "अनुभाग पढ़ें",
                voiceCommandsActive: "वॉयस कमांड सक्रिय। 'एसओएस' या 'अलर्ट ताज़ा करें' कहें।",
                voiceCommandsStopped: "वॉयस कमांड बंद।",
                commandRecognized: "कमांड पहचानी गई: ",
                commandNotRecognized: "कमांड पहचानी नहीं गई। कृपया पुनः प्रयास करें।"
            },
            es: {
                darkModeLabel: "Modo Claro",
                highContrastLabel: "Alto Contraste",
                voiceCommands: "Comandos de Voz",
                alertsTitle: "Alertas de Desastres en Tiempo Real",
                alertsDescription: "Recibe actualizaciones instantáneas sobre peligros cerca de tu ubicación.",
                refreshAlerts: "Actualizar Alertas",
                mapTitle: "Navegación Inteligente y Rutas Seguras",
                mapDescription: "Visualiza zonas de peligro y encuentra las rutas de evacuación más seguras.",
                sosTitle: "SOS de Emergencia con Un Solo Clic",
                sosDescription: "Notifica instantáneamente a tus contactos de confianza durante una crisis.",
                sosButton: "SOS",
                contactsTitle: "Contactos de Emergencia de Confianza",
                contactsDescription: "Agrega números de teléfono para alertar rápidamente en una emergencia.",
                contactNameLabel: "Nombre del Contacto",
                contactPhoneLabel: "Número de Teléfono",
                addContactButton: "Agregar Contacto",
                loadingApp: "Cargando Shield...",
                loadingAlerts: "Obteniendo alertas en tiempo real...",
                loadingMap: "Cargando mapa y rutas...",
                loadingContacts: "Recuperando contactos de confianza...",
                alertSuccess: "SOS enviado con éxito (simulado)! Mantente a salvo.",
                alertError: "No se pudo enviar el SOS. Por favor, inténtalo de nuevo.",
                contactAdded: "¡Contacto añadido con éxito!",
                contactRemoved: "Contacto eliminado.",
                contactAddError: "No se pudo añadir el contacto.",
                contactRemoveError: "No se pudo eliminar el contacto.",
                emailRequired: "El correo electrónico es obligatorio.",
                emailInvalid: "Por favor, introduce una dirección de correo electrónico válida.",
                passwordRequired: "La contraseña es obligatoria.",
                passwordMinLength: "La contraseña debe tener al menos 6 caracteres.",
                contactNameRequired: "El nombre del contacto es obligatorio.",
                contactPhoneRequired: "El número de teléfono es obligatorio.",
                contactPhoneInvalid: "Por favor, introduce un número de teléfono válido (ej. +1234567890).",
                errorPageMessage: "¡Ups! Algo salió mal o la página que buscas no existe.",
                reloadPageButton: "Recargar Página",
                darkModeOn: "Modo Oscuro",
                lightModeOn: "Modo Claro",
                userIdDisplay: "ID de Usuario:",
                mapApiError: "La API de Google Maps no está activada o la clave no es válida. Habilita la API de JavaScript de Maps en tu proyecto de Google Cloud para esta clave de API: https://console.cloud.google.com/apis/library/maps-platform-apis",
                startTour: "Iniciar Tour",
                tutorialSkip: "Omitir Tour",
                tutorialPrev: "Anterior",
                tutorialNext: "Siguiente",
                tutorialWelcome: "¡Hola! Soy tu guía de Shield. ¡Exploremos sus características!",
                tutorialAlerts: "Esta sección proporciona alertas de desastres en tiempo real. Mantente informado sobre los peligros cerca de ti.",
                tutorialMap: "Aquí puedes ver tu ubicación y posibles zonas de peligro en el mapa. Te ayuda a encontrar rutas seguras.",
                tutorialSOS: "En caso de emergencia, un solo clic en este botón SOS notificará a tus contactos de confianza.",
                tutorialContacts: "Gestiona tus contactos de emergencia aquí. Añade o elimina personas a las que quieras alertar durante una crisis.",
                tutorialEnd: "You are finished!",
                sharedStatusTitle: "Actualizaciones de Estado Compartidas",
                sharedStatusDescription: "Comparta actualizaciones en tiempo real con otros usuarios (simulada multiusuario).",
                sendMessageButton: "Enviar",
                sharedStatusNote: "*Este es un feed público y compartido. La verdadera identificación multiusuario requiere cuentas de usuario.",
                messageSent: "¡Mensaje enviado!",
                messageSendError: "No se pudo enviar el mensaje.",
                readSection: "Leer Sección",
                voiceCommandsActive: "Comandos de voz activos. Di 'SOS' o 'Actualizar Alertas'.",
                voiceCommandsStopped: "Comandos de voz detenidos.",
                commandRecognized: "Comando reconocido: ",
                commandNotRecognized: "Comando no reconocido. Por favor, inténtalo de nuevo."
            }
        };
        let currentLanguage = localStorage.getItem('shieldLang') || 'en';
        function showMessageBox(message, type, duration = 3000) {
            messageText.textContent = message;
            messageBox.className = `message-box show ${type}`;
            if (type === 'success') messageIcon.innerHTML = '&#10003;';
            else if (type === 'error') messageIcon.innerHTML = '&#x2716;';
            else messageIcon.innerHTML = '&#x2139;';
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, duration);
        }
        function showLoading(message) {
            loadingMessage.textContent = message;
            loadingOverlay.classList.remove('hidden');
            loadingOverlay.classList.add('show');
        }
        function hideLoading() {
            loadingOverlay.classList.remove('show');
            loadingOverlay.classList.add('hidden');
        }
        function applyLanguage() {
            const lang = translations[currentLanguage];
            if (!lang) return;
            document.querySelectorAll('[data-lang-key]').forEach(element => {
                const key = element.getAttribute('data-lang-key');
                if (lang[key]) {
                    element.textContent = lang[key];
                }
            });
            darkModeLabel.textContent = document.body.classList.contains('dark-mode') ? lang.darkModeOn : lang.lightModeOn;
            highContrastLabel.textContent = document.body.classList.contains('high-contrast-mode') ? "Standard Mode" : lang.highContrastLabel;
            startTourBtn.textContent = lang.startTour;
            tutorialSkipBtn.textContent = lang.tutorialSkip;
            tutorialPrevBtn.textContent = lang.tutorialPrev;
            tutorialNextBtn.textContent = lang.tutorialNext;
            voiceCommandsBtn.textContent = lang.voiceCommands;
            if (mapErrorMessage && mapErrorMessage.style.display !== 'none') {
                 mapErrorMessage.textContent = lang.mapApiError;
            }
            document.querySelectorAll('.read-aloud-btn').forEach(btn => {
                btn.textContent = lang.readSection;
            });
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            darkModeLabel.textContent = isDarkMode ? translations[currentLanguage].darkModeOn : translations[currentLanguage].lightModeOn;
        }
        function toggleHighContrastMode() {
            document.body.classList.toggle('high-contrast-mode');
            const isHighContrast = document.body.classList.contains('high-contrast-mode');
            localStorage.setItem('highContrastMode', isHighContrast ? 'enabled' : 'disabled');
            highContrastLabel.textContent = isHighContrast ? "Standard Mode" : translations[currentLanguage].highContrastLabel;
        }
        function showContent() {
            appContent.classList.remove('hidden');
            fetchDisasterAlerts();
            loadGoogleMaps();
            loadTrustedContacts(); 
            fetchWeatherDataAndApplyTheme(); 
            loadSharedStatusUpdates();
            hideLoading();
        }
        function showCustomErrorPage() {
            appContent.classList.add('hidden');
            errorPage.classList.remove('hidden');
            hideLoading();
        }
    
        async function initializeFirebase() {
            try {
                const firebaseConfig = {
                    apiKey: "YOUR_FIREBASE_API_KEY",
                    authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
                    projectId: "YOUR_FIREBASE_PROJECT_ID",
                    storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
                    messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
                    appId: "YOUR_FIREBASE_APP_ID"
                };
                if (firebaseConfig.apiKey === "YOUR_FIREBASE_API_KEY") {
                    console.warn("Firebase configuration is using placeholder values. Contact saving/loading and shared status will not work.");
                    app = null; 
                    db = null;  
                    userId = 'anonymous_local_user';
                    isAuthReady = true;
                    showContent();
                    return; 
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (!isAuthReady) {
                        isAuthReady = true;
                        if (user) {
                            userId = user.uid;
                        } else {
                            try {
                                const anonUserCred = await signInAnonymously(auth);
                                userId = anonUserCred.user.uid;
                            } catch (anonError) {
                                console.error("Error signing in anonymously:", anonError);
                                showMessageBox("Failed to sign in anonymously. Shared features may not work.", 'error');
                                userId = 'anonymous_error_user';
                            }
                        }
                        console.log("Firebase (Firestore & Anonymous Auth) initialized. User ID:", userId);
                        showContent();
                    }
                    applyLanguage();
                });
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showMessageBox("Firebase initialization failed. Check console for details. Some features disabled.", 'error');
                showCustomErrorPage(); 
                app = null;
                db = null;
                userId = 'initialization_error';
            }
        }
        async function fetchDisasterAlerts() {
            showLoading(translations[currentLanguage].loadingAlerts);
            alertsList.innerHTML = '';
            const allMockAlerts = [
                { type: 'Earthquake', magnitude: 5.2, location: '15km NW of XYZ City', description: 'Moderate earthquake detected. Minor damage possible.' },
                { type: 'Flood Warning', magnitude: 'Severe', location: 'Riverside Area', description: 'Flash flood warning issued for low-lying areas. Seek higher ground.' },
                { type: 'Wildfire Alert', magnitude: 'High', location: 'Forest outskirts, North', description: 'Large wildfire spreading rapidly. Evacuate if in affected zones.' },
                { type: 'Tornado Watch', magnitude: 'Moderate', location: 'Central Plains', description: 'Conditions favorable for tornado development. Stay alert.' },
                { type: 'Heavy Rainfall', magnitude: 'Significant', location: 'Coastal Region', description: 'Heavy rainfall expected, potential for localized flooding.' },
                { type: 'Heatwave Advisory', magnitude: 'Extreme', location: 'Desert Valleys', description: 'Dangerous heatwave. Stay hydrated, avoid prolonged sun exposure.' },
                { type: 'Volcanic Activity', magnitude: 'Minor', location: 'Near Mount Peak', description: 'Increased seismic activity detected near volcano. Monitor updates.' },
                { type: 'Blizzard Warning', magnitude: 'Severe', location: 'Mountain Passes', description: 'Heavy snow and strong winds expected. Travel not recommended.' },
                { type: 'Landslide Risk', magnitude: 'High', location: 'Hilly Terrain', description: 'Increased risk of landslides due to recent rains.' },
                { type: 'Drought Warning', magnitude: 'Critical', location: 'Agricultural Belt', description: 'Severe drought conditions. Conserve water.' },
                { type: 'Cyber Attack', magnitude: 'High', location: 'National Infrastructure', description: 'Critical cyber attack detected. Internet disruptions possible.' },
                { type: 'Chemical Spill', magnitude: 'Localized', location: 'Industrial Park', description: 'Hazardous chemical spill. Shelter in place if nearby.' }
            ];

            const numberOfAlerts = Math.floor(Math.random() * 4) + 3;
            const shuffled = allMockAlerts.sort(() => 0.5 - Math.random());
            const selectedAlerts = shuffled.slice(0, numberOfAlerts);

            setTimeout(() => {
                selectedAlerts.forEach((alert, index) => {
                    const alertCard = document.createElement('div');
                    alertCard.className = 'alert-card';
                    alertCard.innerHTML = `
                        <h3>${alert.type}</h3>
                        <p><strong>Magnitude/Severity:</strong> ${alert.magnitude}</p>
                        <p><strong>Location:</strong> ${alert.location}</p>
                        <p><strong>Description:</strong> ${alert.description}</p>
                        <p class="alert-time">Reported: ${new Date(Date.now() - (index * 15 * 60 * 1000)).toLocaleString()}</p>
                    `;
                    alertsList.appendChild(alertCard);
                });
                hideLoading();
            }, 1500);
        }
        let map;
        let userMarker;
        let directionsService;
        let directionsRenderer;
        function loadGoogleMaps() {
            showLoading(translations[currentLanguage].loadingMap);
            const GOOGLE_MAPS_API_KEY = 'AIzaSyBy3rkdHLTh-WOR2x18SpzVHjw9w4w-FaM';
            if (GOOGLE_MAPS_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY' || !GOOGLE_MAPS_API_KEY) {
                console.error("Google Maps API key is not set or is a placeholder. Map functionality will be limited.");
                mapErrorMessage.textContent = translations[currentLanguage].mapApiError;
                mapErrorMessage.style.display = 'block';
                hideLoading();
                return;
            } else {
                mapErrorMessage.style.display = 'none';
            }
            if (isMapScriptLoaded) {
                console.log("Google Maps script already initiated loading.");
                if (window.google && window.google.maps) {
                    initializeMap();
                } else {
                    console.log("Google Maps script still loading, waiting for callback.");
                }
                hideLoading();
                return;
            }
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&callback=initializeMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            isMapScriptLoaded = true;
            script.onerror = () => {
                console.error("Failed to load Google Maps script. Check your API key and network connection.");
                showMessageBox("Failed to load Google Maps. Check your API key and network.", 'error', 5000);
                mapErrorMessage.textContent = "Failed to load Google Maps script. Check your network and console for details.";
                mapErrorMessage.style.display = 'block';
                hideLoading();
            };
        }
        window.gm_authFailure = function() {
            console.error("Google Maps API authentication failed. Check your API key and its restrictions.");
            mapErrorMessage.textContent = translations[currentLanguage].mapApiError;
            mapErrorMessage.style.display = 'block';
            hideLoading();
        };
        window.initializeMap = function() {
            console.log("initializeMap callback triggered.");
            mapErrorMessage.style.display = 'none';
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API is not fully loaded when initializeMap is called.");
                mapErrorMessage.textContent = translations[currentLanguage].mapApiError;
                mapErrorMessage.style.display = 'block';
                hideLoading();
                return;
            }
            if (!navigator.geolocation) {
                showMessageBox("Geolocation is not supported by your browser. Map will center on a default location.", 'info');
                initializeMapWithCoords({ lat: 23.2599, lng: 77.4126 });
                return;
            }
            try {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Geolocation successful:", position.coords);
                        const userCoords = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        initializeMapWithCoords(userCoords);
                    },
                    (error) => {
                        console.error("Error getting user location:", error.code, error.message || error);
                        let errorMessage = "Could not get your location. Map will center on a default location.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Location access denied. Please enable location services for this site.";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = "Location information unavailable. Check your device settings.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Location request timed out. Try again.";
                        }
                        showMessageBox(errorMessage, 'error');
                        initializeMapWithCoords({ lat: 23.2599, lng: 77.4126 });
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } catch (e) {
                console.error("Geolocation API call failed:", e);
                showMessageBox("Geolocation API call failed. Please ensure your browser supports and allows location services.", 'error');
                initializeMapWithCoords({ lat: 23.2599, lng: 77.4126 });
            }
        };
        function initializeMapWithCoords(coords) {
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error("Map element not found.");
                hideLoading();
                return;
            }
            mapElement.innerHTML = '';
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API is not fully loaded when initializeMapWithCoords is called.");
                mapErrorMessage.textContent = translations[currentLanguage].mapApiError;
                mapErrorMessage.style.display = 'block';
                hideLoading();
                return;
            }
            map = new google.maps.Map(mapElement, {
                center: coords,
                zoom: 12,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                fullscreenControl: false,
                mapTypeControl: false,
                streetViewControl: false,
            });
            userMarker = new google.maps.Marker({
                position: coords,
                map: map,
                title: 'Your Location',
                icon: {
                    url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                    scaledSize: new google.maps.Size(40, 40)
                }
            });
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ map: map, suppressMarkers: true });
            const dangerZones = [
                { lat: 23.2650, lng: 77.4200, name: 'Flood Zone' },
                { lat: 23.2700, lng: 77.4000, name: 'Wildfire Area' }
            ];
            dangerZones.forEach(zone => {
                new google.maps.Marker({
                    position: zone,
                    map: map,
                    title: zone.name,
                    icon: {
                        url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                        scaledSize: new google.maps.Size(40, 40)
                    }
                });
            });
            const origin = coords;
            const destination = { lat: 23.2300, lng: 77.3800 };
            const request = {
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING,
                avoidHighways: false,
                avoidTolls: false
            };
            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                    new google.maps.Marker({
                        position: origin,
                        map: map,
                        title: 'Route Start',
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                            scaledSize: new google.maps.Size(40, 40)
                        }
                    });
                    new google.maps.Marker({
                        position: destination,
                        map: map,
                        title: 'Safe Zone',
                        icon: {
                            url: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
                            scaledSize: new google.maps.Size(40, 40)
                        }
                    });
                } else {
                    console.error('Directions request failed due to ' + status);
                    showMessageBox('Could not find a safe route. Please check your location.', 'error');
                }
            });
            hideLoading();
        }
        const OPENWEATHER_API_KEY = '897ca075931405ab51b2a14a8e8dc211';
        async function fetchWeatherDataAndApplyTheme() {
            if (OPENWEATHER_API_KEY === 'YOUR_OPENWEATHER_API_KEY' || !OPENWEATHER_API_KEY) {
                console.warn("OpenWeatherMap API key is not set. Dynamic theming will not work.");
                return;
            }
            let lat = 23.2599;
            let lon = 77.4126;
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                });
                lat = position.coords.latitude;
                lon = position.coords.longitude;
                console.log("Weather geolocation successful:", lat, lon);
            } catch (error) {
                console.warn("Could not get user location for weather. Using default coordinates.", error.message || error);
            }
            const weatherApiUrl = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${OPENWEATHER_API_KEY}&units=metric`;
            try {
                const response = await fetch(weatherApiUrl);
                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.statusText}`);
                }
                const data = await response.json();
                console.log("Weather data:", data);
                applyThemeBasedOnWeather(data);
            } catch (error) {
                console.error("Failed to fetch weather data:", error);
                showMessageBox("Failed to get weather data for dynamic theming.", 'error');
            }
        }
        function applyThemeBasedOnWeather(weatherData) {
            const weatherCondition = weatherData.weather[0].main.toLowerCase();
            const body = document.body;
            if (weatherCondition.includes('cloud') || weatherCondition.includes('rain') || weatherCondition.includes('snow') || weatherCondition.includes('thunderstorm') || weatherCondition.includes('drizzle')) {
                if (!body.classList.contains('dark-mode')) {
                    body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                }
            } else {
                if (body.classList.contains('dark-mode')) {
                    body.classList.remove('dark-mode');
                    darkModeToggle.checked = false;
                }
            }
            darkModeLabel.textContent = body.classList.contains('dark-mode') ? translations[currentLanguage].darkModeOn : translations[currentLanguage].lightModeOn;
        }
        async function sendSOS() {
            showLoading("Sending SOS...");
            setTimeout(() => {
                showMessageBox(translations[currentLanguage].alertSuccess, 'success');
                hideLoading();
            }, 2000);
        }
        async function addTrustedContact(event) {
            event.preventDefault();
            if (!db) { 
                showMessageBox("Firebase Firestore is not configured. Cannot add contacts.", 'error');
                return;
            }
            const name = contactNameInput.value.trim();
            const phone = contactPhoneInput.value.trim();
            let isValid = true;
            contactNameError.classList.add('hidden');
            contactPhoneError.classList.add('hidden');
            if (!name) {
                contactNameError.textContent = translations[currentLanguage].contactNameRequired;
                contactNameError.classList.remove('hidden');
                isValid = false;
            }
            if (!phone) {
                contactPhoneError.textContent = translations[currentLanguage].contactPhoneRequired;
                contactPhoneError.classList.remove('hidden');
                isValid = false;
            } else if (!/^\+\d{1,15}$/.test(phone)) {
                contactPhoneError.textContent = translations[currentLanguage].contactPhoneInvalid;
                contactPhoneError.classList.remove('hidden');
                isValid = false;
            }
            if (!isValid) return;
            showLoading("Adding contact...");
            try {
                const contactsColRef = collection(db, `artifacts/${appId}/users/${userId}/contacts`);
                await addDoc(contactsColRef, {
                    name: name,
                    phone: phone,
                    createdAt: new Date()
                });
                showMessageBox(translations[currentLanguage].contactAdded, 'success');
                contactNameInput.value = '';
                contactPhoneInput.value = '';
            } catch (error) {
                console.error("Error adding contact:", error);
                showMessageBox(translations[currentLanguage].contactAddError, 'error');
            } finally {
                hideLoading();
            }
        }
        async function deleteTrustedContact(contactId) {
            if (!db) { 
                showMessageBox("Firebase Firestore is not configured. Cannot delete contacts.", 'error');
                return;
            }
            showLoading("Removing contact...");
            try {
                const contactDocRef = doc(db, `artifacts/${appId}/users/${userId}/contacts`, contactId);
                await deleteDoc(contactDocRef);
                showMessageBox(translations[currentLanguage].contactRemoved, 'info');
            } catch (error) {
                console.error("Error deleting contact:", error);
                showMessageBox(translations[currentLanguage].contactRemoveError, 'error');
            } finally {
                hideLoading();
            }
        }
        function loadTrustedContacts() {
            if (!db || !userId || userId === 'anonymous_error_user') {
                contactsList.innerHTML = `<p>${translations[currentLanguage].contactsDescription}</p>`;
                return;
            }
            showLoading(translations[currentLanguage].loadingContacts);
            const contactsColRef = collection(db, `artifacts/${appId}/users/${userId}/contacts`);
            onSnapshot(contactsColRef, (snapshot) => {
                contactsList.innerHTML = '';
                if (snapshot.empty) {
                    contactsList.innerHTML = `<p>${translations[currentLanguage].contactsDescription}</p>`;
                } else {
                    snapshot.forEach(doc => {
                        const contact = doc.data();
                        const contactCard = document.createElement('div');
                        contactCard.className = 'contact-card';
                        contactCard.innerHTML = `
                            <p><strong>${contact.name}</strong>: ${contact.phone}</p>
                            <button data-id="${doc.id}">Delete</button>
                        `;
                        contactCard.querySelector('button').addEventListener('click', () => deleteTrustedContact(doc.id));
                        contactsList.appendChild(contactCard);
                    });
                }
                hideLoading();
            }, (error) => {
                console.error("Error fetching contacts:", error);
                showMessageBox("Failed to load contacts.", 'error');
                hideLoading();
            });
        }
        async function sendMessage(event) {
            event.preventDefault();
            if (!db || !userId || userId === 'anonymous_error_user') {
                showMessageBox("Firebase Firestore is not configured or anonymous authentication failed. Cannot send messages.", 'error');
                return;
            }
            const messageText = messageInput.value.trim();
            if (!messageText) {
                showMessageBox("Message cannot be empty.", 'info');
                return;
            }
            showLoading(translations[currentLanguage].messageSendError);
            try {
                const messagesColRef = collection(db, `artifacts/${appId}/public/data/shared_status_updates`);
                await addDoc(messagesColRef, {
                    senderId: userId,
                    message: messageText,
                    timestamp: new Date()
                });
                showMessageBox(translations[currentLanguage].messageSent, 'success');
                messageInput.value = '';
            } catch (error) {
                console.error("Error sending message:", error);
                showMessageBox(translations[currentLanguage].messageSendError, 'error');
            } finally {
                hideLoading();
            }
        }
        function loadSharedStatusUpdates() {
            if (!db || !userId || userId === 'anonymous_error_user') {
                messageFeed.innerHTML = `<p>${translations[currentLanguage].sharedStatusDescription}</p>`;
                return;
            }
            showLoading(translations[currentLanguage].loadingMessages);
            const messagesColRef = collection(db, `artifacts/${appId}/public/data/shared_status_updates`);
            const q = query(messagesColRef, orderBy("timestamp", "desc"), limit(10));
            onSnapshot(q, (snapshot) => {
                messageFeed.innerHTML = '';
                if (snapshot.empty) {
                    messageFeed.innerHTML = `<p>${translations[currentLanguage].sharedStatusDescription}</p>`;
                } else {
                    snapshot.forEach(doc => { // Iterate normally, as flex-direction is now column
                        const messageData = doc.data();
                        const senderDisplay = messageData.senderId.substring(0, 8) + '...';
                        const messageItem = document.createElement('div');
                        messageItem.className = 'message-item';
                        messageItem.innerHTML = `<strong>${senderDisplay}:</strong> ${messageData.message}`;
                        messageFeed.appendChild(messageItem); // Append to bottom
                    });
                }
                hideLoading();
            }, (error) => {
                console.error("Error fetching shared messages:", error);
                showMessageBox("Failed to load shared messages.", 'error');
                hideLoading();
            });
        }
        const synth = window.speechSynthesis;
        let currentUtterance = null;
        function speakText(text) {
            if (!synth) {
                showMessageBox("Text-to-speech not supported in your browser.", 'error');
                return;
            }
            if (currentUtterance && synth.speaking) {
                synth.cancel();
            }
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = currentLanguage;
            currentUtterance.rate = 1;
            currentUtterance.pitch = 1;
            
            // Log available voices for debugging
            synth.onvoiceschanged = () => {
                console.log("Available voices:", synth.getVoices());
            };
            // Call immediately if voices are already loaded
            if (synth.getVoices().length > 0) {
                console.log("Available voices (initial):", synth.getVoices());
            }

            synth.speak(currentUtterance);
        }
        function stopSpeaking() {
            if (synth && synth.speaking) {
                synth.cancel();
            }
        }
        let recognition = null;
        let isVoiceCommandActive = false;
        function startVoiceCommands() {
            if (!('webkitSpeechRecognition' in window)) {
                showMessageBox("Voice commands not supported in your browser. Use Chrome for best results.", 'error', 5000);
                return;
            }
            if (recognition) {
                recognition.stop();
            }
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentLanguage;
            recognition.onstart = () => {
                isVoiceCommandActive = true;
                showMessageBox(translations[currentLanguage].voiceCommandsActive, 'info', 0);
                voiceCommandsBtn.textContent = "Stop Voice Commands";
                voiceCommandsBtn.classList.remove('btn-outline');
                voiceCommandsBtn.classList.add('btn-primary');
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.toLowerCase();
                showMessageBox(translations[currentLanguage].commandRecognized + transcript, 'success');
                console.log("Voice command recognized:", transcript);
                if (transcript.includes('sos')) {
                    sendSOS();
                } else if (transcript.includes('refresh alerts') || transcript.includes('refresh alert')) {
                    fetchDisasterAlerts();
                } else if (transcript.includes('read alerts') || transcript.includes('read alert section')) {
                    readSectionContent('alert-section');
                } else if (transcript.includes('read map') || transcript.includes('read map section')) {
                    readSectionContent('map-section');
                } else if (transcript.includes('read sos') || transcript.includes('read sos section')) {
                    readSectionContent('sos-section');
                } else if (transcript.includes('read contacts') || transcript.includes('read contacts section')) {
                    readSectionContent('contacts-section');
                } else if (transcript.includes('read shared') || transcript.includes('read shared status')) {
                    readSectionContent('shared-status-section');
                }
                else {
                    showMessageBox(translations[currentLanguage].commandNotRecognized, 'error');
                }
            };
            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                if (event.error === 'not-allowed') {
                    showMessageBox("Microphone access denied. Please allow microphone access for voice commands.", 'error', 7000);
                } else if (event.error === 'no-speech') {
                } else {
                    showMessageBox("Voice command error: " + event.error, 'error');
                }
                stopVoiceCommands();
            };
            recognition.onend = () => {
                if (isVoiceCommandActive) {
                    stopVoiceCommands();
                }
            };
            recognition.start();
        }
        function stopVoiceCommands() {
            if (recognition) {
                recognition.stop();
                isVoiceCommandActive = false;
                showMessageBox(translations[currentLanguage].voiceCommandsStopped, 'info');
                voiceCommandsBtn.textContent = translations[currentLanguage].voiceCommands;
                voiceCommandsBtn.classList.remove('btn-primary');
                voiceCommandsBtn.classList.add('btn-outline');
            }
        }
        function toggleVoiceCommands() {
            if (isVoiceCommandActive) {
                stopVoiceCommands();
            } else {
                startVoiceCommands();
            }
        }
        function readSectionContent(sectionId) {
            const sectionElement = document.getElementById(sectionId);
            if (sectionElement) {
                const title = sectionElement.querySelector('h2 span[data-lang-key]').textContent;
                const description = sectionElement.querySelector('p[data-lang-key]').textContent;
                let contentToSpeak = `${title}. ${description}.`; // Add a period for better pause

                if (sectionId === 'alert-section') {
                    const alerts = sectionElement.querySelectorAll('.alert-card');
                    if (alerts.length > 0) {
                        contentToSpeak += " Current alerts include: ";
                        alerts.forEach((alert) => {
                            const type = alert.querySelector('h3').textContent;
                            // Get the full text content of the p tags, then clean it up
                            const magnitudeText = alert.querySelector('p:nth-of-type(1)').textContent.trim();
                            const locationText = alert.querySelector('p:nth-of-type(2)').textContent.trim();
                            const descriptionText = alert.querySelector('p:nth-of-type(3)').textContent.trim();
                            contentToSpeak += `${type}. ${magnitudeText}. ${locationText}. ${descriptionText}. `;
                        });
                    } else {
                        contentToSpeak += " No active alerts at this time.";
                    }
                }
                else if (sectionId === 'contacts-section') {
                    const contacts = sectionElement.querySelectorAll('.contact-card p');
                    if (contacts.length > 0) {
                        contentToSpeak += " Your trusted contacts include: ";
                        contacts.forEach((contact) => {
                            contentToSpeak += `${contact.textContent}. `;
                        });
                    } else {
                        contentToSpeak += " You have no trusted contacts added yet.";
                    }
                }
                else if (sectionId === 'shared-status-section') {
                    const messages = sectionElement.querySelectorAll('.message-item');
                    if (messages.length > 0) {
                        contentToSpeak += " Recent messages: ";
                        // Read only a few recent messages to avoid very long speech
                        Array.from(messages).reverse().slice(0, 3).forEach((message) => { // Get last 3 messages
                            contentToSpeak += `${message.textContent}. `;
                        });
                    } else {
                        contentToSpeak += " No shared status updates yet.";
                    }
                }
                console.log("Attempting to speak:", contentToSpeak); // For debugging
                speakText(contentToSpeak);
            }
        }
        let currentTutorialStepIndex = -1;
        const tutorialSteps = [
            {
                id: null,
                character: '👋',
                messageKey: 'tutorialWelcome'
            },
            {
                id: 'alert-section',
                character: '🚨',
                messageKey: 'tutorialAlerts'
            },
            {
                id: 'map-section',
                character: '🗺️',
                messageKey: 'tutorialMap'
            },
            {
                id: 'sos-section',
                character: '🆘',
                messageKey: 'tutorialSOS'
            },
            {
                id: 'contacts-section',
                character: '📞',
                messageKey: 'tutorialContacts'
            },
            {
                id: 'shared-status-section', 
                character: '💬',
                messageKey: 'sharedStatusTitle' 
            },
            {
                id: null, 
                character: '✅',
                messageKey: 'tutorialEnd'
            }
        ];
        function startTutorial() {
            currentTutorialStepIndex = 0;
            tutorialOverlay.classList.remove('hidden');
            tutorialOverlay.classList.add('show');
            // The map-click-blocker is no longer needed as tutorial-overlay covers everything
            // and has the highest z-index, blocking all clicks underneath.
            showTutorialStep(currentTutorialStepIndex);
        }
        function showTutorialStep(index) {
            if (index < 0 || index >= tutorialSteps.length) {
                endTutorial();
                return;
            }
            // Remove highlight from previous step if any
            if (currentTutorialStepIndex > -1 && tutorialSteps[currentTutorialStepIndex].id) {
                const prevElement = document.getElementById(tutorialSteps[currentTutorialStepIndex].id);
                if (prevElement) {
                    prevElement.classList.remove('tutorial-highlight');
                }
            }
            currentTutorialStepIndex = index;
            const step = tutorialSteps[currentTutorialStepIndex];
            const lang = translations[currentLanguage];
            tutorialCharacter.textContent = step.character;
            tutorialMessage.textContent = lang[step.messageKey];
            tutorialPrevBtn.style.display = currentTutorialStepIndex === 0 ? 'none' : 'inline-flex';
            tutorialNextBtn.style.display = currentTutorialStepIndex === tutorialSteps.length - 1 ? 'none' : 'inline-flex';
            tutorialSkipBtn.textContent = currentTutorialStepIndex === tutorialSteps.length - 1 ? lang.tutorialSkip : lang.tutorialSkip;
            if (step.id) {
                const targetElement = document.getElementById(step.id);
                if (targetElement) {
                    targetElement.classList.add('tutorial-highlight');
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        }
        function nextTutorialStep() {
            if (currentTutorialStepIndex < tutorialSteps.length - 1) {
                showTutorialStep(currentTutorialStepIndex + 1);
            } else {
                endTutorial();
            }
        }
        function prevTutorialStep() {
            if (currentTutorialStepIndex > 0) {
                showTutorialStep(currentTutorialStepIndex - 1);
            }
        }
        function endTutorial() {
            tutorialOverlay.classList.remove('show');
            tutorialOverlay.classList.add('hidden');
            // Ensure any active highlight is removed
            if (currentTutorialStepIndex > -1 && tutorialSteps[currentTutorialStepIndex].id) {
                const prevElement = document.getElementById(tutorialSteps[currentTutorialStepIndex].id);
                if (prevElement) {
                    prevElement.classList.remove('tutorial-highlight');
                }
            }
            currentTutorialStepIndex = -1;
        }
        document.addEventListener('DOMContentLoaded', () => {
            showLoading(translations[currentLanguage].loadingApp);
            initializeFirebase();
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'enabled') {
                document.body.classList.add('dark-mode');
                darkModeToggle.checked = true;
            }
            darkModeLabel.textContent = document.body.classList.contains('dark-mode') ? translations[currentLanguage].darkModeOn : translations[currentLanguage].lightModeOn;
            darkModeToggle.addEventListener('change', toggleDarkMode);
            const savedHighContrastMode = localStorage.getItem('highContrastMode');
            if (savedHighContrastMode === 'enabled') {
                document.body.classList.add('high-contrast-mode');
                highContrastToggle.checked = true;
            }
            highContrastLabel.textContent = document.body.classList.contains('high-contrast-mode') ? "Standard Mode" : translations[currentLanguage].highContrastLabel;
            highContrastToggle.addEventListener('change', toggleHighContrastMode);
            languageSwitcher.value = currentLanguage;
            applyLanguage();
            languageSwitcher.addEventListener('change', (event) => {
                currentLanguage = event.target.value;
                localStorage.setItem('shieldLang', currentLanguage);
                applyLanguage();
            });
            refreshAlertsBtn.addEventListener('click', fetchDisasterAlerts);
            sosButton.addEventListener('click', sendSOS);
            addContactForm.addEventListener('submit', addTrustedContact);
            sendMessageForm.addEventListener('submit', sendMessage); 
            document.querySelectorAll('.read-aloud-btn').forEach(btn => {
                btn.addEventListener('click', (event) => {
                    const sectionId = event.target.dataset.section;
                    readSectionContent(sectionId);
                });
            });
            voiceCommandsBtn.addEventListener('click', toggleVoiceCommands);
            startTourBtn.addEventListener('click', startTutorial);
            tutorialNextBtn.addEventListener('click', nextTutorialStep);
            tutorialPrevBtn.addEventListener('click', prevTutorialStep);
            tutorialSkipBtn.addEventListener('click', endTutorial);
        });
        window.initializeMap = window.initializeMap || function() { console.log("Google Maps callback placeholder."); };
    </script>
</body>
</html>
